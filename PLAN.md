# План реализации FindOrigin

Поэтапный порядок действий по созданию Telegram-бота FindOrigin на основе PROJECT.md.

---

## Этап 1. Инициализация проекта

1. **Создать Next.js-приложение**  
   - Инициализировать проект (например, `create-next-app`)  
   - Настроить TypeScript, ESLint, структуру папок  

2. **Подготовить окружение**  
   - Добавить `.env.local` с переменными: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_SECRET` (при необходимости), ключи для AI и поиска  
   - Убедиться, что `.env` и секреты в `.gitignore`  

3. **Базовая конфигурация**  
   - Настроить `next.config.js` под Vercel  
   - Добавить `vercel.json` при необходимости (маршруты, функции и т.п.)

---

## Этап 2. Telegram Webhook API

4. **Реализовать endpoint для webhook**  
   - Создать API-route (например, `app/api/webhook/telegram/route.ts` или `pages/api/webhook/telegram.ts`)  
   - Принимать только `POST`  
   - Проверять источник запроса (по возможности — secret token / подпись)  

5. **Парсинг update**  
   - Извлекать `update.message`  
   - Доставать `chat.id` и `text` (или `caption` для медиа)  
   - Обрабатывать только текстовые сообщения; при необходимости — другие типы (например, ссылки)  

6. **Быстрый ответ 200 OK**  
   - Сразу отправить `res.status(200).end()` (или эквивалент)  
   - Вся тяжёлая обработка — в фоне (очередь, отдельный воркер, serverless-функция и т.д.)  

7. **Отправка ответа пользователю**  
   - Реализовать вызов Telegram API `sendMessage`  
   - Использовать `TELEGRAM_BOT_TOKEN`  
   - Отправлять сообщения асинхронно после завершения обработки  

8. **Регистрация webhook**  
   - Настроить URL webhook на Vercel (например, `https://<project>.vercel.app/api/webhook/telegram`)  
   - Документировать команду/скрипт для установки webhook через Telegram Bot API  

---

## Этап 3. Ввод и извлечение данных

9. **Обработка ввода пользователя**  
   - **Текст:** использовать `message.text` как есть  
   - **Ссылка на Telegram-пост:** определить, что сообщение — ссылка (t.me/..., telegram.me/...), при необходимости разбирать `post_id` и т.п.  

10. **Извлечение контента из поста по ссылке**  
    - При ссылке на пост: получать содержимое поста (Telegram API, если доступно, или внешние средства — с учётом ограничений и ToS)  
    - Сохранять извлечённый текст в едином формате для дальнейшей обработки  

11. **Нормализация текста**  
    - Очистка от лишних пробелов, переносов  
    - Приведение к единому формату (например, UTF-8, нормализация пробелов)

---

## Этап 4. Анализ текста и выделение сущностей

12. **Выделение ключевых элементов**  
    Реализовать модуль анализа текста, который извлекает:  
    - ключевые утверждения (короткие тезисы)  
    - даты  
    - числа  
    - имена (персоны, организации)  
    - ссылки  

13. **Выбор инструментов**  
    - Использовать готовые библиотеки (NLP, регулярные выражения) или AI для извлечения сущностей  
    - Определить формат выходных данных (JSON-структура с полями: claims, dates, numbers, names, links)  

14. **Формирование поисковых запросов**  
    - На основе выделенных сущностей строить поисковые запросы  
    - Учитывать даты, имена, ключевые слова; при необходимости — несколько вариантов запроса  

---

## Этап 5. Поиск источников

15. **Интеграция поиска**  
    - Выбрать поисковый API (Google Custom Search, Bing, SerpAPI и т.д.) или парсинг при разрешённом использовании  
    - Реализовать модуль поиска с запросами из п. 14  

16. **Фильтрация по типам источников**  
    - Определить эвристики/правила для отнесения сайтов к категориям:  
      - официальные сайты  
      - новостные сайты  
      - блоги  
      - исследования (научные статьи, отчёты и т.д.)  
    - По возможности отдавать приоритет надёжным типам источников  

17. **Сбор кандидатов**  
    - Собрать список кандидатов (URL + заголовок + сниппет/фрагмент текста)  
    - Ограничить объём (например, топ-N результатов по каждому запросу) для последующей передачи в AI  

---

## Этап 6. AI-сравнение и ранжирование

18. **Интеграция AI**  
    - Подключить провайдера (OpenAI, Anthropic, локальная модель и т.д.)  
    - Выделить конфиг (модель, API key, лимиты)  

19. **Подготовка промпта**  
    - Исходный текст (или тезисы) + список кандидатов (URL, заголовок, сниппет)  
    - Чёткая инструкция: сравнить **смысл**, а не буквальное совпадение текста  

20. **Обработка ответа AI**  
    - Парсить структурированный вывод (например, JSON): список источников (1–3 ссылки) + оценка уверенности по каждому  
    - Обрабатывать ошибки и нестандартные ответы  

21. **Ранжирование и отбор**  
    - Выбрать 1–3 лучших источника по уверенности  
    - При равной уверенности — использовать дополнительные правила (тип источника, дата и т.д.)

---

## Этап 7. Ответ пользователю и UX

22. **Форматирование ответа**  
    - Краткое описание: что искали, что нашли  
    - Список 1–3 ссылок с подписями  
    - Оценка уверенности (например, «Высокая / Средняя / Низкая» или в процентах)  

23. **Отправка в Telegram**  
    - Использовать `sendMessage` с поддержкой Markdown/HTML при необходимости  
    - Укладываться в лимиты Telegram (длина сообщения и т.д.); при длинном ответе — разбивать на несколько сообщений  

24. **Обработка ошибок**  
    - Сообщать пользователю о сбоях (поиск, AI, сеть) понятным текстом  
    - Логировать ошибки для отладки  

---

## Этап 8. Деплой и эксплуатация

25. **Деплой на Vercel**  
    - Подключить репозиторий к Vercel  
    - Настроить переменные окружения (токены, API-ключи)  
    - Проверить, что webhook доступен по HTTPS  

26. **Установка webhook**  
    - После деплоя вызвать `setWebhook` с URL продакшена  
    - Проверить получение updates через webhook  

27. **Тестирование**  
    - Юнит-тесты для парсинга update, извлечения сущностей, формирования поисковых запросов  
    - Интеграционные тесты: webhook → поиск → AI → ответ  
    - Ручная проверка в Telegram: текст, ссылки на посты, краевые случаи  

28. **Документация и мониторинг**  
    - Обновить README: назначение бота, как запускать локально, как деплоить, как поменять webhook  
    - При необходимости настроить мониторинг (логи, алерты) в Vercel или внешних сервисах  

---

## Порядок выполнения (сводка)

| №  | Этап                          | Задачи                                      |
|----|-------------------------------|---------------------------------------------|
| 1  | Инициализация проекта         | 1–3                                         |
| 2  | Telegram Webhook API          | 4–8                                         |
| 3  | Ввод и извлечение данных      | 9–11                                        |
| 4  | Анализ текста и сущности      | 12–14                                       |
| 5  | Поиск источников              | 15–17                                       |
| 6  | AI-сравнение и ранжирование   | 18–21                                       |
| 7  | Ответ пользователю и UX       | 22–24                                       |
| 8  | Деплой и эксплуатация         | 25–28                                       |

После каждого этапа рекомендуется проверять работу по цепочке (например, webhook → ответ «принято» → затем полный пайплайн до отправки результатов в Telegram).
